#!/bin/bash
#
# Copyright (C) 2022  David Valin dvalin@redhat.com
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#

lv_disks=""
lv_total_size=0
lv_disk_count=0;
devices_to_use=""
devices_list=""
lvm_vol=""
lvm_grp=""
wipefs=0

error_out()
{
	echo $1
	exit $2
}

usage()
{
	echo "Usage: $1"
	echo "   --devices_to_use: comma separated list of devices to use"
	echo "   --lvm_grp: name of the lvm group creating"
	echo "   --lvm_vol: name of the lvm volume creating"
	echo "   --wipefs: wipe the device before doing the lvm operations"
	exit 0
}

#
# Verify the passed data is correct.
#
validate_data()
{
	if [[ $lvm_vol = "" ]]; then
		error_out "Need to designate an lvm_vol name." 1
	fi
	if [[ $lvm_grp = "" ]]; then
		error_out "Need to designate an lvm_grp name." 1
	fi
	if [[ $devices_to_use = "" ]]; then
		error_out "Need to designate at least one device to use." 1
	fi
	for i in $devices_to_use;
	do
		if [[ ! -e $i ]]; then
			error_out "Error, device $i not found." 1
		fi
	done
}

#
# Define options
#
ARGUMENT_LIST=(
        "devices"
	"lvm_vol"
        "lvm_grp"
)

NO_ARGUMENTS=(
	"wipefs"
        "usage"
)

# read arguments
opts=$(getopt \
    --longoptions "$(printf "%s:," "${ARGUMENT_LIST[@]}")" \
    --longoptions "$(printf "%s," "${NO_ARGUMENTS[@]}")" \
    --name "$(basename "$0")" \
    --options "h" \
    -- "$@"
)

if [ $? -ne 0 ]; then
        exit 0
fi
eval set -- "$opts"

while [[ $# -gt 0 ]]; do
	case "$1" in
		--devices)
			devices_list=${2}
			shift 2
		;;
		--lvm_vol)
			lvm_vol=${2}
			shift 2
		;;
		--lvm_grp)
			lvm_grp=${2}
			shift 2
		;;
		--usage)
			usage $0
		;;
		--wipefs)
			wipefs=1
			shift 1
		;;
		-h)
			usage $0
		;;
		--)
			break;
		;;
		*)
			echo option not found $1
			usage $0
		;;
	esac
done

devices_to_use=`echo $devices_list | sed "s/,/ /g"`
validate_data

seper=""
for i in $devices_to_use; do
	lv_disks=${i}${seper}${lv_disks}
	size=`lsblk -b -d -n -o SIZE $i`
	gb=`echo "$size/(1024*1024*1024)" | bc`
	let "lv_total_size=$lv_total_size+$gb"
	let "lv_disk_count=$lv_disk_count+1"
	seper=" "
	if [ $wipefs -eq 1 ]; then
		wipefs -a $i
	fi
done
lvremove -f $lvm_vol/$lvm_grp
vgremove -f $lvm_vol

let "total_size=$lv_total_size-200"
pvcreate -ff $lv_disks
if [ $? -ne 0 ]; then
	error_out "pvcreate -ff $lv_disks failed." 1
fi
sleep 60
vgcreate $lvm_vol $lv_disks
if [ $? -ne 0 ]; then
	error_out "vgcreate $lvm_vol $lv_disks failed" 1
fi
sleep 60
lvcreate -Zy -Wy --yes -i $lv_disk_count -L  ${total_size}G -n $lvm_vol $lvm_grp
if [ $? -ne 0 ]; then
	error_out "lvcreate -Zy -Wy --yes -i $lv_disk_count -L  ${total_size}G -n $lvm_vol $lvm_grp failed." 1
fi
wipefs -f /dev/$lvm_vol/$lvm_grp
exit 0
