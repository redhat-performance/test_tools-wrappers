#!/bin/bash

config="supported_os.yml"
os_release=1 # /etc/os-release more reliable, so use it by default

usage()
{
    echo -e "detect_os"
    echo -e "\t Detects the OS that the system is currently using and prints it out"
    echo -e "Options"
    
    echo -e "\t --uname"
    echo -e "\t\t Determine the current OS using 'uname -a' output"
    echo -e "\t\t Combining this option with --os-release produces undefined behavior"

    echo -e "\t --os-release"
    echo -e "\t\t Determine the current OS using the /etc/os-release file"
    echo -e "\t\t Combining this option with --uname produces undefined behavior"

    echo -e "\t -h/--help/--usage"
    echo -e "\t\t Displays this message"

    exit 0
}

echo_stderr() {
    echo ${@:1} > /dev/stderr
}

parse_os_release_file()
{
    local os_id=`grep '^ID=' /etc/os-release | cut -d'=' -f2 | sed -e "s/\"\|'//g"`

    local config_len=`yq '. | length' $config`
    for i in `seq 0 $config_len`;do
        local identifier=`yq -r ".[$i].identifier" $config`
        
         if [ $identifier = $os_id ]; then
            echo $identifier
            exit 0
        fi
    done

    echo_stderr Unknown os \"$os_id\", check $config to make sure it exists
}

parse_uname()
{
    local kinfo=`uname -a`

    local config_len=`yq '. | length' $config`
    for i in `seq 0 $config_len`;do
        local pattern=`yq -r ".[$i].uname_pattern" $config`
        local identifier=`yq -r ".[$i].identifier" $config`
        
         if `echo $kinfo | grep -Eq $pattern`; then
            echo $identifier
            exit 0
        fi
    done

    echo_stderr No known uname pattern matches, check $config to ensure that a pattern matches the following uname line
    echo_stderr $kinfo
    exit 1
}

NOARG_OPTS=(
    "uname"
    "h"
    "help"

    "usage"
    "os-release"
)

opts=$(getopt \
    --longoptions "$(printf "%s," "${NOARG_OPTS[@]}")" \
    --name "$(basename "$0")" \
    --options "h" \
    -- "$@"
)

if [ $? -ne 0 ]; then
        exit 1
fi

eval set --$opts

while [[ $# -gt 0 ]]; do
	case "$1" in
    -h | --usage | --help)
        usage
    ;;
    --uname)
        os_release=0
        shift 1
    ;;
    --os-release)
        os_release=1
        shift 1
    ;;
    --)
        break;
    ;;
    *)
        echo_stderr Unknown option $1
        exit 1
    ;;
    esac
done


if [ $os_release -eq 1 ]; then
    parse_os_release_file
else
    parse_uname
fi

exit 0
